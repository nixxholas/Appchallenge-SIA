<!DOCTYPE html>
<html>
    <head>
        <title>-</title>
        <script src="./js/d3.js"></script>
        <script src="./js/jquery-3.1.1.js"></script>
        <script src="./js/bootstrap.js"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <link rel="stylesheet" href="./css/bootstrap.css">
    </head>

    <body>
        <div class="">
            <div id="priceChart" style="width: 500px; height: 300px"></div>
            <svg id="priceHistory"></svg>
            <form class="form form-group">
                <input id="priceSlider" type="range" min="700" max="1100"
                steps="10" class=""/>
                <input id="priceThreshold" type="number"/>
                <button type="button" class="btn btn-default" aria-label="Left
                Align">
                    <span class="glyphicon glyphicon-next"
                          aria-hidden="true"></span> Next
                </button>
            </form>
            <script>
let today = new Date();
today.setHours(0, 0, 0, 0);

// Placeholder data
let flightDate = new Date("12 Oct 2016");
let todaysPrice = 980;
let priceHistory = [1000, 950, 930, 920, 900, 910, 940, 960, 1000, 1030, 1050];

// Convert to plain old javascript object
let data = [];
priceHistory.forEach((v, i) => {
    let dateStamp = new Date();
    dateStamp.setDate(flightDate.getDate() - i);
    dateStamp.setHours(0, 0, 0, 0);
    data.push({
        price: v,
        dateStamp: dateStamp
    });
});

let margin = {top: 20, right: 50, bottom: 100, left: 50};
let width = 500 - margin.left - margin.right;
let height = 320 - margin.top - margin.bottom;

let minDate = new Date();
minDate.setDate(flightDate.getDate() - 10);
let maxDate = flightDate;

let minPrice = d3.min(priceHistory) - 100;
let maxPrice = d3.max(priceHistory);
let minPriceDate = data.slice().sort((a, b) => a.price < b.price).pop();

// d3 scales
let y = d3.scaleLinear()
    .domain([minPrice, maxPrice])
    .range([height, 0]);

let x = d3.scaleTime()
    .domain([minDate, maxDate])
    .range([0, width]);

// d3 axis
let yAxis = d3.axisLeft().scale(y).ticks(10);
let xAxis = d3.axisBottom().scale(x).ticks(d3.timeDay);

let svg = d3.select("#priceHistory")
    .attr('width', 500)
    .attr('height', 320)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append('g').attr("transform", "translate(0," + height + ")").call(xAxis);
svg.append('g').attr("transform", "translate(0,0)").call(yAxis);

// d3 points
let rect = svg.selectAll("circle")
    .data(data).enter()
    .append("circle")
    .attr("cx", (d) => x(d.dateStamp))
    .attr("cy", (d) => y(d.price))
    .attr("dateStamp", (d) => d.dateStamp)
    .attr("price", (d) => d.price)
    .attr("fill", "blue")
    .attr("r", 2)
    .on("mouseover", function() {
        console.log(this);
    });

// curve
let line = d3.line()
    .curve(d3.curveCardinal)
    .x((d) => x(d.dateStamp))
    .y((d) => y(d.price));
let path = svg.append("path")
    .datum(data)
    .attr("class", "line")
    .attr("d", line)
    .attr("fill", "none")
    .attr("stroke", "black")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", "1");
    //.on("mouseover", function() { console.log(this); });

// price slider
let price = 1000;

// let priceThresholdLine = svg.append("line")
//     .attr("x1", 0)
//     .attr("x2", width)
//     .attr("y1", y(price))
//     .attr("y2", y(price))
//     .style("stroke", "black")
//     .style("stroke-dasharray", "3, 3")
//     .attr("width", 2);

// today line
if (today > minDate && today < maxDate) {
    let todayLine = svg.append("line")
        .attr("x1", x(today))
        .attr("x2", x(today))
        .attr("y1", 0)
        .attr("y2", height)
        .style("stroke", "black")
        .style("stroke-dasharray", "3, 3")
        .attr("width", 2);
    let todayText = svg.append("text")
        .attr("x", x(today))
        .attr("y", height)
        .attr("dy", 40)
        .attr("text-anchor", "middle")
        .text("Today");
    let todayPrice = svg.append("text")
        .attr("x", x(today))
        .attr("y", height)
        .attr("dy", 60)
        .attr("text-anchor", "middle")
        .text("$" + todaysPrice);
}

// lowest line
let lowestLine = svg.append("line")
    .attr("x1", x(minPriceDate.dateStamp))
    .attr("x2", x(minPriceDate.dateStamp))
    .attr("y1", 0)
    .attr("y2", height)
    .style("stroke", "black")
    .style("stroke-dasharray", "3, 3")
    .attr("width", 2);
let lowestText = svg.append("text")
    .attr("x", x(minPriceDate.dateStamp))
    .attr("y", height)
    .attr("dy", 40)
    .attr("text-anchor", "middle")
    .text("Lowest");
let lowestPrice = svg.append("text")
    .attr("x", x(minPriceDate.dateStamp))
    .attr("y", height)
    .attr("dy", 60)
    .attr("text-anchor", "middle")
    .text("$" + minPriceDate.price);

// flight date line
let flightDateLine = svg.append("line")
    .attr("x1", x(flightDate))
    .attr("x2", x(flightDate))
    .attr("y1", 0)
    .attr("y2", height)
    .style("stroke", "black")
    .style("stroke-dasharray", "3, 3")
    .attr("width", 2);
let flightDateText = svg.append("text")
    .attr("x", x(flightDate))
    .attr("y", height)
    .attr("dy", 40)
    .attr("text-anchor", "middle")
    .text("Flight");

// price slider stuff
$priceSlider = $("#priceSlider");
$priceSlider.val(price);
$("#priceOutput").text(price);

$priceSlider.on("input", function() {
        $("#priceThreshold").val($priceSlider.val());
        //priceThresholdLine.attr("y1", y($priceSlider.val()));
        //priceThresholdLine.attr("y2", y($priceSlider.val()));
    });

google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(drawChart);

function drawChart() {
    var data = google.visualization.arrayToDataTable([
    ['Year', 'Sales', 'Expenses'],
    ['2004',  1000,      400],
    ['2005',  1170,      460],
    ['2006',  660,       1120],
    ['2007',  1030,      540]
    ]);

    var options = {
    title: 'Company Performance',
    curveType: 'function',
    legend: { position: 'bottom' }
    };

    var chart = new google.visualization.LineChart(document.getElementById('priceChart'));

    chart.draw(data, options);
}

            </script>
        </div>
    </body>
</html>
